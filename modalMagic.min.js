angular.module("dc.modalMagic",[]);angular.module("dc.modalMagic").factory("modalMagic",["$injector","$q",function(e,t){var n,r;n=function(){function n(t){this.modalPromise=null;this.data=t.data||{};this.templateUrl=t.templateUrl||function(){throw new Error("need templateUrl")}();this.isValid=t.isValid||function(e){return true};this.onSubmit=t.onSubmit||function(e){return true};this.$modal=e.get("$modal")}n.prototype.asPromise=function(e,n){var r,i;i=e(n);if(i&&i.then){return i}else{r=t.defer();if(i){r.resolve(i)}else{r.reject(i)}return r.promise}};n.prototype.open=function(){console.log("open");return this.onlyOne().then(function(e){return function(t){e.data=t;return e.data}}(this))["catch"](function(e){return function(t){e.modalPromise=null;console.error("YOU CANNOT ESCAPE YOUR DESTINY",t,e.data);return e.open()}}(this))};n.prototype.onlyOne=function(){console.log("open once");if(this.modalPromise){console.log("open modal");return this.modalPromise}this.modalPromise=this.openModal().then(function(e){return function(t){return e.asPromise(e.isValid,t)}}(this));return this.modalPromise.then(function(e){console.log("good?",e);this.modalPromise=null;return e})["catch"](function(e){console.log("error?",e);this.modalPromise=null;throw e})};n.prototype.openModal=function(){var e,t;console.log("openModal");t=this;e=this.$modal.open({templateUrl:this.templateUrl,controller:function(e,n){console.log("data",t.data);e.data=t.data;e.submit=function(){var r,i,s;i=angular.copy(t.data);for(r in i){s=i[r];if(e.data[r]!==void 0){i[r]=e.data[r]}}console.log("save from cow",i);return t.asPromise(t.onSubmit,i).then(function(e){console.log("onSubmit success",e);return n.close(e)})["catch"](function(e){console.error("onSubmit failed",e);return n.dismiss(e)})};return e.close=function(){console.log("closed from cow");return n.dismiss("closed")}}});return e.result};return n}();r={};return{get:function(e,t){if(r[e]){console.log("returning highlander");return r[e]}r[e]=new n(t);return r[e]}}}])